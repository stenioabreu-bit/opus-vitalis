<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Dados dos Relat√≥rios</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <style>
        .debug-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .debug-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .debug-log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .data-table th,
        .data-table td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: left;
            font-size: 12px;
        }
        
        .data-table th {
            background: var(--bg-secondary);
            font-weight: bold;
        }
        
        .test-button {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .test-button:hover {
            background: #0099cc;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>üîç Debug - Dados dos Relat√≥rios</h1>
        
        <div class="debug-section">
            <h2>Usu√°rio Atual</h2>
            <div id="current-user-info"></div>
        </div>
        
        <div class="debug-section">
            <h2>Todos os Relat√≥rios no Firebase</h2>
            <button id="load-all-reports" class="test-button">Carregar Todos os Relat√≥rios</button>
            <div id="all-reports-table"></div>
        </div>
        
        <div class="debug-section">
            <h2>Relat√≥rios Filtrados para o Usu√°rio</h2>
            <button id="load-user-reports" class="test-button">Carregar Relat√≥rios do Usu√°rio</button>
            <div id="user-reports-table"></div>
        </div>
        
        <div class="debug-section">
            <h2>Debug Log</h2>
            <div id="debug-log" class="debug-log"></div>
            <button id="clear-log" class="test-button">Clear Log</button>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    
    <script src="scripts/utils.js"></script>
    <script src="scripts/auth.js"></script>
    <script src="scripts/data-loader.js"></script>
    <script src="scripts/firebase.js"></script>
    <script src="scripts/reports.js"></script>
    
    <script>
        let debugLog = '';
        let currentUser = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLog += logEntry + '\n';
            
            const logElement = document.getElementById('debug-log');
            logElement.textContent = debugLog;
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logEntry);
        }
        
        function createTable(data, containerId) {
            const container = document.getElementById(containerId);
            
            if (!data || data.length === 0) {
                container.innerHTML = '<p>Nenhum dado encontrado</p>';
                return;
            }
            
            const keys = Object.keys(data[0]);
            let html = '<table class="data-table"><thead><tr>';
            
            keys.forEach(key => {
                html += `<th>${key}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            data.forEach(item => {
                html += '<tr>';
                keys.forEach(key => {
                    let value = item[key];
                    if (typeof value === 'object') {
                        value = JSON.stringify(value);
                    }
                    html += `<td>${value || 'N/A'}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        async function initDebug() {
            log('üöÄ Iniciando debug dos dados dos relat√≥rios', 'info');
            
            // Check session
            const authService = new AuthService();
            if (!authService.checkSession()) {
                log('‚ùå Usu√°rio n√£o autenticado', 'error');
                document.getElementById('current-user-info').innerHTML = '<p style="color: red;">Usu√°rio n√£o autenticado. <a href="login.html">Fazer login</a></p>';
                return;
            }
            
            currentUser = authService.getCurrentUser();
            log(`üë§ Usu√°rio atual: ${currentUser.name} (ID: ${currentUser.id})`, 'info');
            
            document.getElementById('current-user-info').innerHTML = `
                <p><strong>Nome:</strong> ${currentUser.name}</p>
                <p><strong>ID:</strong> ${currentUser.id}</p>
                <p><strong>Username:</strong> ${currentUser.username}</p>
                <p><strong>Role:</strong> ${currentUser.role || 'N/A'}</p>
            `;
            
            // Initialize Firebase
            try {
                if (!window.firebaseService) {
                    window.firebaseService = new FirebaseService();
                    await window.firebaseService.init();
                }
                
                if (!window.firebaseReportsService) {
                    window.firebaseReportsService = new FirebaseReportsService();
                    await window.firebaseReportsService.init();
                }
                
                log('‚úÖ Firebase inicializado', 'success');
            } catch (error) {
                log(`‚ùå Erro ao inicializar Firebase: ${error.message}`, 'error');
            }
        }
        
        async function loadAllReports() {
            log('üìä Carregando todos os relat√≥rios do Firebase...', 'info');
            
            try {
                if (!window.firebaseService) {
                    throw new Error('Firebase service n√£o encontrado');
                }
                
                if (!window.firebaseService.isInitialized()) {
                    throw new Error('Firebase n√£o inicializado');
                }
                
                const db = window.firebaseService.getDB();
                const snapshot = await db.collection('relatorios').get();
                
                log(`üìä Encontrados ${snapshot.size} relat√≥rios no Firebase`, 'info');
                
                const reports = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    reports.push({
                        id: doc.id,
                        titulo: data.titulo,
                        autor: data.autor,
                        authorName: data.authorName,
                        criadoEm: new Date(data.criadoEm).toLocaleString(),
                        missionDate: data.missionDate,
                        status: data.status,
                        compartilhadoCom: JSON.stringify(data.compartilhadoCom || [])
                    });
                });
                
                createTable(reports, 'all-reports-table');
                
                // Log detalhado
                reports.forEach(report => {
                    log(`üìÑ Relat√≥rio: ${report.titulo} | Autor: ${report.autor} | AuthorName: ${report.authorName}`, 'info');
                });
                
            } catch (error) {
                log(`‚ùå Erro ao carregar relat√≥rios: ${error.message}`, 'error');
            }
        }
        
        async function loadUserReports() {
            log('üë§ Carregando relat√≥rios do usu√°rio atual...', 'info');
            
            try {
                if (!currentUser) {
                    throw new Error('Usu√°rio n√£o definido');
                }
                
                if (!window.firebaseReportsService) {
                    throw new Error('Firebase Reports Service n√£o inicializado');
                }
                
                const isLeader = currentUser.role === 'leader';
                log(`üîç Carregando para usu√°rio: ${currentUser.id}, isLeader: ${isLeader}`, 'info');
                
                const reports = await window.firebaseReportsService.loadReports(currentUser.id, isLeader);
                
                log(`üìä Relat√≥rios filtrados: ${reports.length}`, 'info');
                
                const tableData = reports.map(report => ({
                    id: report.id,
                    title: report.title,
                    authorId: report.authorId,
                    authorName: report.authorName,
                    createdAt: new Date(report.createdAt).toLocaleString(),
                    missionDate: report.missionDate,
                    status: report.status
                }));
                
                createTable(tableData, 'user-reports-table');
                
                // Log detalhado
                reports.forEach(report => {
                    log(`‚úÖ Relat√≥rio filtrado: ${report.title} | AuthorId: ${report.authorId} | CurrentUserId: ${currentUser.id}`, 'info');
                });
                
            } catch (error) {
                log(`‚ùå Erro ao carregar relat√≥rios do usu√°rio: ${error.message}`, 'error');
            }
        }
        
        // Event listeners
        document.getElementById('load-all-reports').addEventListener('click', loadAllReports);
        document.getElementById('load-user-reports').addEventListener('click', loadUserReports);
        document.getElementById('clear-log').addEventListener('click', () => {
            debugLog = '';
            document.getElementById('debug-log').textContent = '';
        });
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initDebug);
    </script>
</body>
</html>