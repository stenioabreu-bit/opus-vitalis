<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corre칞칚o - Problemas de Autentica칞칚o</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <style>
        .fix-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .fix-title {
            color: var(--accent-blue);
            font-weight: bold;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        .fix-info {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
        }
        
        .success { color: var(--success-green); }
        .error { color: var(--error-red); }
        .warning { color: #ffa500; }
        
        .fix-button {
            margin: 10px 5px;
            padding: 10px 15px;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .fix-button:hover {
            background: #0099cc;
        }
        
        .fix-button.danger {
            background: var(--error-red);
        }
        
        .fix-button.danger:hover {
            background: #cc0000;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="color: var(--accent-blue); text-align: center; margin-bottom: 30px;">
            游댢 Corre칞칚o de Problemas de Autentica칞칚o
        </h1>
        
        <div class="fix-section">
            <div class="fix-title">1. Limpeza de Sess칚o Corrompida</div>
            <div id="session-fix-info" class="fix-info">Aguardando corre칞칚o...</div>
            <button class="fix-button danger" onclick="clearCorruptedSession()">Limpar Sess칚o Corrompida</button>
            <button class="fix-button" onclick="checkSessionHealth()">Verificar Sa칰de da Sess칚o</button>
        </div>
        
        <div class="fix-section">
            <div class="fix-title">2. Corre칞칚o de Migra칞칚o</div>
            <div id="migration-fix-info" class="fix-info">Aguardando corre칞칚o...</div>
            <button class="fix-button" onclick="forceMigration()">For칞ar Migra칞칚o</button>
            <button class="fix-button danger" onclick="cleanOldData()">Limpar Dados Antigos</button>
        </div>
        
        <div class="fix-section">
            <div class="fix-title">3. Teste de Login Completo</div>
            <div id="login-test-info" class="fix-info">Aguardando teste...</div>
            <div style="margin: 15px 0;">
                <label>Usu치rio: <input type="text" id="test-username" value="bella_evans" style="margin-left: 10px; padding: 5px;"></label>
                <label style="margin-left: 15px;">Senha: <input type="password" id="test-password" value="s칚ocristov칚o2016" style="margin-left: 10px; padding: 5px;"></label>
            </div>
            <button class="fix-button" onclick="testCompleteLogin()">Testar Login Completo</button>
        </div>
        
        <div class="fix-section">
            <div class="fix-title">4. Corre칞칚o de Relat칩rios Compartilhados</div>
            <div id="sharing-fix-info" class="fix-info">Aguardando corre칞칚o...</div>
            <button class="fix-button" onclick="createTestSharedReport()">Criar Relat칩rio de Teste</button>
            <button class="fix-button" onclick="shareTestReport()">Compartilhar com Outros Usu치rios</button>
            <button class="fix-button" onclick="verifySharedReports()">Verificar Compartilhamentos</button>
        </div>
        
        <div class="fix-section">
            <div class="fix-title">5. Reset Completo do Sistema</div>
            <div id="reset-info" class="fix-info">丘멆잺 ATEN칂츾O: Isso apagar치 todos os dados locais!</div>
            <button class="fix-button danger" onclick="resetSystem()">Reset Completo</button>
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
            <a href="dashboard.html" class="btn btn-primary">Voltar ao Dashboard</a>
            <a href="test-auth-debug.html" class="btn btn-secondary">Voltar ao Debug</a>
        </div>
    </div>

    <!-- Scripts -->
    <script src="scripts/utils.js"></script>
    <script src="scripts/auth.js"></script>
    <script src="scripts/data-loader.js"></script>
    <script src="scripts/reports.js"></script>
    <script src="scripts/migration.js"></script>
    
    <script>
        let authService, reportsService, migrationService;
        
        // Initialize services
        document.addEventListener('DOMContentLoaded', function() {
            authService = new AuthService();
            reportsService = new ReportsService();
            migrationService = new OpusVitalisMigration();
        });
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            
            element.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
        }
        
        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }
        
        // 1. Limpeza de Sess칚o Corrompida
        function clearCorruptedSession() {
            clearLog('session-fix-info');
            log('session-fix-info', 'Iniciando limpeza de sess칚o corrompida...');
            
            try {
                // Limpar todas as chaves relacionadas  sess칚o
                const keysToRemove = [
                    'opus_vitalis_session',
                    'ordem_paranormal_session',
                    'opus_vitalis_reports',
                    'ordem_paranormal_reports',
                    'opus_vitalis_notifications',
                    'ordem_paranormal_notifications'
                ];
                
                keysToRemove.forEach(key => {
                    if (localStorage.getItem(key)) {
                        localStorage.removeItem(key);
                        log('session-fix-info', `Removido: ${key}`, 'success');
                    }
                });
                
                // Limpar cache do AuthService
                if (authService) {
                    authService.currentUser = null;
                    log('session-fix-info', 'Cache do AuthService limpo', 'success');
                }
                
                log('session-fix-info', 'Limpeza conclu칤da! Fa칞a login novamente.', 'success');
                
            } catch (error) {
                log('session-fix-info', `ERRO: ${error.message}`, 'error');
            }
        }
        
        function checkSessionHealth() {
            clearLog('session-fix-info');
            log('session-fix-info', 'Verificando sa칰de da sess칚o...');
            
            try {
                const sessionData = localStorage.getItem('opus_vitalis_session');
                
                if (!sessionData) {
                    log('session-fix-info', 'Nenhuma sess칚o encontrada - OK', 'success');
                    return;
                }
                
                const parsed = JSON.parse(sessionData);
                
                // Verificar campos obrigat칩rios
                const requiredFields = ['id', 'username', 'name'];
                const missingFields = requiredFields.filter(field => !parsed[field]);
                
                if (missingFields.length > 0) {
                    log('session-fix-info', `Campos obrigat칩rios ausentes: ${missingFields.join(', ')}`, 'error');
                    log('session-fix-info', 'Sess칚o corrompida detectada!', 'error');
                } else {
                    log('session-fix-info', 'Sess칚o v치lida encontrada', 'success');
                    log('session-fix-info', `Usu치rio: ${parsed.username} (${parsed.name})`, 'info');
                }
                
            } catch (error) {
                log('session-fix-info', `Sess칚o corrompida: ${error.message}`, 'error');
            }
        }
        
        // 2. Corre칞칚o de Migra칞칚o
        function forceMigration() {
            clearLog('migration-fix-info');
            log('migration-fix-info', 'For칞ando migra칞칚o...');
            
            try {
                const result = migrationService.migrateData();
                
                if (result.success) {
                    log('migration-fix-info', 'Migra칞칚o for칞ada conclu칤da!', 'success');
                    log('migration-fix-info', `Sess칫es: ${result.sessionsMigrated}`, 'info');
                    log('migration-fix-info', `Relat칩rios: ${result.reportsMigrated}`, 'info');
                } else {
                    log('migration-fix-info', `ERRO: ${result.message}`, 'error');
                }
                
            } catch (error) {
                log('migration-fix-info', `ERRO: ${error.message}`, 'error');
            }
        }
        
        function cleanOldData() {
            clearLog('migration-fix-info');
            log('migration-fix-info', 'Limpando dados antigos...');
            
            try {
                migrationService.cleanup();
                log('migration-fix-info', 'Limpeza de dados antigos conclu칤da!', 'success');
            } catch (error) {
                log('migration-fix-info', `ERRO: ${error.message}`, 'error');
            }
        }
        
        // 3. Teste de Login Completo
        async function testCompleteLogin() {
            clearLog('login-test-info');
            log('login-test-info', 'Iniciando teste de login completo...');
            
            try {
                const username = document.getElementById('test-username').value;
                const password = document.getElementById('test-password').value;
                
                if (!username || !password) {
                    log('login-test-info', 'ERRO: Preencha usu치rio e senha', 'error');
                    return;
                }
                
                log('login-test-info', `Testando login: ${username}`, 'info');
                
                // Limpar sess칚o atual
                authService.currentUser = null;
                localStorage.removeItem('opus_vitalis_session');
                
                // Tentar login
                const result = await authService.handleLogin(username, password);
                
                if (result.success) {
                    log('login-test-info', 'LOGIN SUCESSO!', 'success');
                    log('login-test-info', `Usu치rio: ${result.user.name}`, 'success');
                    log('login-test-info', `Role: ${result.user.role}`, 'info');
                    
                    // Verificar se sess칚o foi salva
                    const savedSession = localStorage.getItem('opus_vitalis_session');
                    if (savedSession) {
                        log('login-test-info', 'Sess칚o salva corretamente no localStorage', 'success');
                    } else {
                        log('login-test-info', 'AVISO: Sess칚o n칚o foi salva no localStorage', 'warning');
                    }
                    
                } else {
                    log('login-test-info', `LOGIN FALHOU: ${result.message}`, 'error');
                }
                
            } catch (error) {
                log('login-test-info', `ERRO no teste: ${error.message}`, 'error');
            }
        }
        
        // 4. Corre칞칚o de Relat칩rios Compartilhados
        async function createTestSharedReport() {
            clearLog('sharing-fix-info');
            log('sharing-fix-info', 'Criando relat칩rio de teste...');
            
            try {
                // Verificar se usu치rio est치 logado
                const currentUser = authService.getCurrentUser();
                if (!currentUser) {
                    log('sharing-fix-info', 'ERRO: Fa칞a login primeiro', 'error');
                    return;
                }
                
                const testData = {
                    title: 'Relat칩rio de Teste - Compartilhamento',
                    description: 'Este relat칩rio foi criado para testar a funcionalidade de compartilhamento entre usu치rios.',
                    missionDate: new Date().toISOString().split('T')[0],
                    status: 'completed'
                };
                
                const result = await reportsService.createReport(testData);
                
                if (result.success) {
                    log('sharing-fix-info', 'Relat칩rio de teste criado!', 'success');
                    log('sharing-fix-info', `ID: ${result.report.id}`, 'info');
                    window.testReportId = result.report.id; // Salvar para pr칩ximo teste
                } else {
                    log('sharing-fix-info', `ERRO: ${result.message}`, 'error');
                }
                
            } catch (error) {
                log('sharing-fix-info', `ERRO: ${error.message}`, 'error');
            }
        }
        
        async function shareTestReport() {
            clearLog('sharing-fix-info');
            log('sharing-fix-info', 'Compartilhando relat칩rio de teste...');
            
            try {
                if (!window.testReportId) {
                    log('sharing-fix-info', 'ERRO: Crie um relat칩rio de teste primeiro', 'error');
                    return;
                }
                
                const currentUser = authService.getCurrentUser();
                if (!currentUser) {
                    log('sharing-fix-info', 'ERRO: Fa칞a login primeiro', 'error');
                    return;
                }
                
                // Obter outros usu치rios para compartilhar
                const availableUsers = await reportsService.getAvailableUsers(currentUser.id);
                log('sharing-fix-info', `Usu치rios dispon칤veis: ${availableUsers.length}`, 'info');
                
                if (availableUsers.length === 0) {
                    log('sharing-fix-info', 'Nenhum usu치rio dispon칤vel para compartilhar', 'warning');
                    return;
                }
                
                // Compartilhar com o primeiro usu치rio dispon칤vel
                const targetUserId = availableUsers[0].id;
                log('sharing-fix-info', `Compartilhando com: ${availableUsers[0].name}`, 'info');
                
                const result = await reportsService.shareReport(
                    window.testReportId, 
                    [targetUserId], 
                    currentUser.id
                );
                
                if (result.success) {
                    log('sharing-fix-info', 'Relat칩rio compartilhado com sucesso!', 'success');
                    log('sharing-fix-info', result.message, 'success');
                } else {
                    log('sharing-fix-info', `ERRO: ${result.message}`, 'error');
                }
                
            } catch (error) {
                log('sharing-fix-info', `ERRO: ${error.message}`, 'error');
            }
        }
        
        async function verifySharedReports() {
            clearLog('sharing-fix-info');
            log('sharing-fix-info', 'Verificando relat칩rios compartilhados...');
            
            try {
                const currentUser = authService.getCurrentUser();
                if (!currentUser) {
                    log('sharing-fix-info', 'ERRO: Fa칞a login primeiro', 'error');
                    return;
                }
                
                // Verificar relat칩rios compartilhados
                const sharedReports = await reportsService.loadSharedReports(currentUser.id);
                log('sharing-fix-info', `Relat칩rios compartilhados encontrados: ${sharedReports.length}`, 'info');
                
                if (sharedReports.length > 0) {
                    sharedReports.forEach((report, index) => {
                        log('sharing-fix-info', `${index + 1}. "${report.title}" por ${report.authorName}`, 'success');
                    });
                } else {
                    log('sharing-fix-info', 'Nenhum relat칩rio compartilhado encontrado', 'warning');
                }
                
                // Verificar notifica칞칫es
                const notifications = await reportsService.getNotificationsForUser(currentUser.id);
                log('sharing-fix-info', `Notifica칞칫es: ${notifications.length}`, 'info');
                
            } catch (error) {
                log('sharing-fix-info', `ERRO: ${error.message}`, 'error');
            }
        }
        
        // 5. Reset Completo
        function resetSystem() {
            if (!confirm('ATEN칂츾O: Isso apagar치 TODOS os dados locais. Tem certeza?')) {
                return;
            }
            
            if (!confirm('칔ltima chance! Todos os relat칩rios e configura칞칫es ser칚o perdidos. Continuar?')) {
                return;
            }
            
            clearLog('reset-info');
            log('reset-info', 'Iniciando reset completo do sistema...');
            
            try {
                // Limpar todo o localStorage
                localStorage.clear();
                log('reset-info', 'LocalStorage limpo', 'success');
                
                // Limpar caches dos servi칞os
                if (authService) {
                    authService.currentUser = null;
                }
                
                if (reportsService && reportsService.dataLoader) {
                    reportsService.dataLoader.clearCache();
                }
                
                log('reset-info', 'Caches limpos', 'success');
                log('reset-info', 'Reset completo conclu칤do!', 'success');
                log('reset-info', 'Redirecionando para login...', 'info');
                
                // Redirecionar para login ap칩s 3 segundos
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 3000);
                
            } catch (error) {
                log('reset-info', `ERRO: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>