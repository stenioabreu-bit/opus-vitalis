<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Problemas de Autentica칞칚o</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <style>
        .debug-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .debug-title {
            color: var(--accent-blue);
            font-weight: bold;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        .debug-info {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
        }
        
        .success { color: var(--success-green); }
        .error { color: var(--error-red); }
        .warning { color: #ffa500; }
        
        .test-button {
            margin: 10px 5px;
            padding: 10px 15px;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .test-button:hover {
            background: #0099cc;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="color: var(--accent-blue); text-align: center; margin-bottom: 30px;">
            游댌 Debug - Problemas de Autentica칞칚o
        </h1>
        
        <div class="debug-section">
            <div class="debug-title">1. Verifica칞칚o de Sess칚o</div>
            <div id="session-info" class="debug-info">Verificando...</div>
            <button class="test-button" onclick="checkSession()">Verificar Sess칚o</button>
        </div>
        
        <div class="debug-section">
            <div class="debug-title">2. Teste de Cria칞칚o de Relat칩rio</div>
            <div id="create-report-info" class="debug-info">Aguardando teste...</div>
            <button class="test-button" onclick="testCreateReport()">Testar Cria칞칚o</button>
        </div>
        
        <div class="debug-section">
            <div class="debug-title">3. Teste de Relat칩rios Compartilhados</div>
            <div id="shared-reports-info" class="debug-info">Aguardando teste...</div>
            <button class="test-button" onclick="testSharedReports()">Testar Compartilhados</button>
        </div>
        
        <div class="debug-section">
            <div class="debug-title">4. Verifica칞칚o de LocalStorage</div>
            <div id="storage-info" class="debug-info">Aguardando verifica칞칚o...</div>
            <button class="test-button" onclick="checkStorage()">Verificar Storage</button>
        </div>
        
        <div class="debug-section">
            <div class="debug-title">5. Teste de Migra칞칚o</div>
            <div id="migration-info" class="debug-info">Aguardando teste...</div>
            <button class="test-button" onclick="testMigration()">Testar Migra칞칚o</button>
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
            <a href="dashboard.html" class="btn btn-primary">Voltar ao Dashboard</a>
            <button class="test-button" onclick="runAllTests()">Executar Todos os Testes</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="scripts/utils.js"></script>
    <script src="scripts/auth.js"></script>
    <script src="scripts/data-loader.js"></script>
    <script src="scripts/reports.js"></script>
    <script src="scripts/migration.js"></script>
    
    <script>
        let authService, reportsService, migrationService;
        
        // Initialize services
        document.addEventListener('DOMContentLoaded', function() {
            authService = new AuthService();
            reportsService = new ReportsService();
            migrationService = new MigrationService();
            
            // Auto-run initial checks
            setTimeout(() => {
                checkSession();
                checkStorage();
            }, 500);
        });
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            
            element.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
        }
        
        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }
        
        // 1. Verifica칞칚o de Sess칚o
        function checkSession() {
            clearLog('session-info');
            log('session-info', 'Iniciando verifica칞칚o de sess칚o...');
            
            try {
                // Verificar se AuthService existe
                if (!authService) {
                    log('session-info', 'ERRO: AuthService n칚o inicializado', 'error');
                    return;
                }
                
                // Verificar sess칚o
                const hasSession = authService.checkSession();
                log('session-info', `Sess칚o ativa: ${hasSession}`, hasSession ? 'success' : 'warning');
                
                // Verificar usu치rio atual
                const currentUser = authService.getCurrentUser();
                if (currentUser) {
                    log('session-info', `Usu치rio logado: ${currentUser.username} (ID: ${currentUser.id})`, 'success');
                    log('session-info', `Nome: ${currentUser.name}`, 'info');
                    log('session-info', `Role: ${currentUser.role}`, 'info');
                } else {
                    log('session-info', 'Nenhum usu치rio logado', 'warning');
                }
                
                // Verificar localStorage
                const sessionData = localStorage.getItem('opus_vitalis_session');
                if (sessionData) {
                    log('session-info', 'Dados de sess칚o encontrados no localStorage', 'success');
                    try {
                        const parsed = JSON.parse(sessionData);
                        log('session-info', `Dados v치lidos: ${JSON.stringify(parsed, null, 2)}`, 'info');
                    } catch (e) {
                        log('session-info', 'ERRO: Dados de sess칚o corrompidos', 'error');
                    }
                } else {
                    log('session-info', 'Nenhum dado de sess칚o no localStorage', 'warning');
                }
                
            } catch (error) {
                log('session-info', `ERRO na verifica칞칚o: ${error.message}`, 'error');
                console.error('Session check error:', error);
            }
        }
        
        // 2. Teste de Cria칞칚o de Relat칩rio
        async function testCreateReport() {
            clearLog('create-report-info');
            log('create-report-info', 'Iniciando teste de cria칞칚o de relat칩rio...');
            
            try {
                // Verificar se usu치rio est치 logado
                const currentUser = authService.getCurrentUser();
                if (!currentUser) {
                    log('create-report-info', 'ERRO: Usu치rio n칚o autenticado', 'error');
                    return;
                }
                
                log('create-report-info', `Usu치rio autenticado: ${currentUser.username}`, 'success');
                
                // Dados de teste
                const testReportData = {
                    title: 'Relat칩rio de Teste - ' + new Date().toLocaleString(),
                    description: 'Este 칠 um relat칩rio de teste criado para verificar a funcionalidade de cria칞칚o.',
                    missionDate: new Date().toISOString().split('T')[0],
                    status: 'completed'
                };
                
                log('create-report-info', 'Dados do relat칩rio de teste:', 'info');
                log('create-report-info', JSON.stringify(testReportData, null, 2), 'info');
                
                // Tentar criar relat칩rio
                log('create-report-info', 'Chamando reportsService.createReport()...', 'info');
                const result = await reportsService.createReport(testReportData);
                
                if (result.success) {
                    log('create-report-info', 'SUCESSO: Relat칩rio criado com sucesso!', 'success');
                    log('create-report-info', `ID do relat칩rio: ${result.report.id}`, 'success');
                    
                    // Verificar se foi salvo no localStorage
                    const localReports = reportsService.getLocalReports();
                    if (localReports[result.report.id]) {
                        log('create-report-info', 'Relat칩rio encontrado no localStorage', 'success');
                    } else {
                        log('create-report-info', 'AVISO: Relat칩rio n칚o encontrado no localStorage', 'warning');
                    }
                } else {
                    log('create-report-info', `ERRO: ${result.message}`, 'error');
                }
                
            } catch (error) {
                log('create-report-info', `ERRO na cria칞칚o: ${error.message}`, 'error');
                console.error('Create report test error:', error);
            }
        }
        
        // 3. Teste de Relat칩rios Compartilhados
        async function testSharedReports() {
            clearLog('shared-reports-info');
            log('shared-reports-info', 'Iniciando teste de relat칩rios compartilhados...');
            
            try {
                const currentUser = authService.getCurrentUser();
                if (!currentUser) {
                    log('shared-reports-info', 'ERRO: Usu치rio n칚o autenticado', 'error');
                    return;
                }
                
                log('shared-reports-info', `Usu치rio: ${currentUser.username} (ID: ${currentUser.id})`, 'info');
                
                // Carregar todos os relat칩rios
                log('shared-reports-info', 'Carregando todos os relat칩rios...', 'info');
                const allReports = await reportsService.getAllReports();
                log('shared-reports-info', `Total de relat칩rios: ${Object.keys(allReports).length}`, 'info');
                
                // Carregar relat칩rios compartilhados
                log('shared-reports-info', 'Carregando relat칩rios compartilhados...', 'info');
                const sharedReports = await reportsService.loadSharedReports(currentUser.id);
                log('shared-reports-info', `Relat칩rios compartilhados: ${sharedReports.length}`, 'info');
                
                if (sharedReports.length > 0) {
                    log('shared-reports-info', 'Relat칩rios compartilhados encontrados:', 'success');
                    sharedReports.forEach((report, index) => {
                        log('shared-reports-info', `${index + 1}. "${report.title}" por ${report.authorName}`, 'info');
                    });
                } else {
                    log('shared-reports-info', 'Nenhum relat칩rio compartilhado encontrado', 'warning');
                    
                    // Verificar se existem relat칩rios com sharedWith
                    const reportsWithSharing = Object.values(allReports).filter(report => 
                        report.sharedWith && report.sharedWith.length > 0
                    );
                    log('shared-reports-info', `Relat칩rios com compartilhamento: ${reportsWithSharing.length}`, 'info');
                    
                    if (reportsWithSharing.length > 0) {
                        log('shared-reports-info', 'Relat칩rios com compartilhamento:', 'info');
                        reportsWithSharing.forEach((report, index) => {
                            log('shared-reports-info', `${index + 1}. "${report.title}" compartilhado com: [${report.sharedWith.join(', ')}]`, 'info');
                        });
                    }
                }
                
                // Carregar notifica칞칫es
                log('shared-reports-info', 'Carregando notifica칞칫es...', 'info');
                const notifications = await reportsService.getNotificationsForUser(currentUser.id);
                log('shared-reports-info', `Notifica칞칫es: ${notifications.length}`, 'info');
                
                if (notifications.length > 0) {
                    const unread = notifications.filter(n => !n.read).length;
                    log('shared-reports-info', `N칚o lidas: ${unread}`, unread > 0 ? 'warning' : 'info');
                }
                
            } catch (error) {
                log('shared-reports-info', `ERRO no teste: ${error.message}`, 'error');
                console.error('Shared reports test error:', error);
            }
        }
        
        // 4. Verifica칞칚o de LocalStorage
        function checkStorage() {
            clearLog('storage-info');
            log('storage-info', 'Verificando localStorage...');
            
            try {
                // Verificar chaves relacionadas ao sistema
                const keys = [
                    'opus_vitalis_session',
                    'opus_vitalis_reports',
                    'opus_vitalis_notifications',
                    'ordem_paranormal_session', // chave antiga
                    'ordem_paranormal_reports'  // chave antiga
                ];
                
                keys.forEach(key => {
                    const value = localStorage.getItem(key);
                    if (value) {
                        log('storage-info', `${key}: ENCONTRADO (${value.length} chars)`, 'success');
                        try {
                            const parsed = JSON.parse(value);
                            if (typeof parsed === 'object') {
                                const count = Array.isArray(parsed) ? parsed.length : Object.keys(parsed).length;
                                log('storage-info', `  較덕 Cont칠m ${count} item(s)`, 'info');
                            }
                        } catch (e) {
                            log('storage-info', `  較덕 N칚o 칠 JSON v치lido`, 'warning');
                        }
                    } else {
                        log('storage-info', `${key}: n칚o encontrado`, 'info');
                    }
                });
                
                // Verificar capacidade do localStorage
                let totalSize = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        totalSize += localStorage[key].length;
                    }
                }
                log('storage-info', `Tamanho total do localStorage: ${totalSize} chars`, 'info');
                
            } catch (error) {
                log('storage-info', `ERRO na verifica칞칚o: ${error.message}`, 'error');
            }
        }
        
        // 5. Teste de Migra칞칚o
        async function testMigration() {
            clearLog('migration-info');
            log('migration-info', 'Testando sistema de migra칞칚o...');
            
            try {
                if (!migrationService) {
                    log('migration-info', 'ERRO: MigrationService n칚o dispon칤vel', 'error');
                    return;
                }
                
                // Verificar se h치 dados antigos
                const hasOldData = migrationService.hasOldData();
                log('migration-info', `Dados antigos encontrados: ${hasOldData}`, hasOldData ? 'warning' : 'info');
                
                if (hasOldData) {
                    log('migration-info', 'Executando migra칞칚o...', 'info');
                    const result = migrationService.migrateData();
                    
                    if (result.success) {
                        log('migration-info', 'Migra칞칚o conclu칤da com sucesso!', 'success');
                        log('migration-info', `Sess칫es migradas: ${result.sessionsMigrated}`, 'info');
                        log('migration-info', `Relat칩rios migrados: ${result.reportsMigrated}`, 'info');
                    } else {
                        log('migration-info', `ERRO na migra칞칚o: ${result.message}`, 'error');
                    }
                } else {
                    log('migration-info', 'Nenhuma migra칞칚o necess치ria', 'success');
                }
                
            } catch (error) {
                log('migration-info', `ERRO no teste: ${error.message}`, 'error');
            }
        }
        
        // Executar todos os testes
        async function runAllTests() {
            checkSession();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testCreateReport();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testSharedReports();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            checkStorage();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testMigration();
        }
    </script>
</body>
</html>