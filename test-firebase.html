<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Firebase - Estrutura Firestore</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <style>
        .test-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .log {
            background: var(--bg-secondary);
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: var(--success-green); }
        .error { color: var(--error-red); }
        .info { color: var(--text-primary); }
        .warning { color: var(--warning-orange); }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¥ Teste Firebase - Estrutura Firestore</h1>
        
        <div class="test-section">
            <h2>ğŸ“‹ Estrutura dos Dados</h2>
            <p>Testando a estrutura exata do Firestore:</p>
            <pre style="color: var(--text-secondary); font-size: 12px;">
/relatorios
    â””â”€â”€ 4F38GDL2P9D8 (id aleatÃ³rio)
        â”œâ”€â”€ titulo: "RelatÃ³rio 1"
        â”œâ”€â”€ conteudo: "Texto aqui"
        â”œâ”€â”€ autor: "user_001"
        â”œâ”€â”€ compartilhadoCom: ["user_002"]
        â”œâ”€â”€ criadoEm: timestamp
        â”œâ”€â”€ missionDate: "2024-12-04"
        â”œâ”€â”€ status: "completed"
        â””â”€â”€ authorName: "Bella Evans"
            </pre>
        </div>

        <div class="test-section">
            <h2>ğŸ§ª Testes</h2>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="testFirebaseConnection()">
                    ğŸ”¥ Testar ConexÃ£o Firebase
                </button>
                <button class="btn btn-secondary" onclick="testCreateReport()">
                    ğŸ“ Criar RelatÃ³rio Teste
                </button>
                <button class="btn btn-secondary" onclick="testLoadReports()">
                    ğŸ“‹ Carregar RelatÃ³rios
                </button>
                <button class="btn btn-secondary" onclick="testShareReport()">
                    ğŸ”— Testar Compartilhamento
                </button>
                <button class="btn btn-danger" onclick="clearLog()">
                    ğŸ—‘ï¸ Limpar Log
                </button>
            </div>
            <div id="test-log" class="log"></div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    
    <!-- App Scripts -->
    <script src="scripts/utils.js"></script>
    <script src="scripts/auth.js"></script>
    <script src="scripts/data-loader.js"></script>
    <script src="scripts/firebase.js"></script>
    <script src="scripts/reports.js"></script>
    
    <script>
        function log(message, type = 'info') {
            const logEl = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${timestamp}] ${message}`;
            logEl.appendChild(div);
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('test-log').innerHTML = '';
        }

        async function testFirebaseConnection() {
            log('ğŸ”¥ Testando conexÃ£o com Firebase...', 'info');
            
            try {
                // Test Firebase initialization
                if (window.firebaseService) {
                    const initialized = await window.firebaseService.init();
                    if (initialized) {
                        log('âœ… Firebase conectado com sucesso!', 'success');
                        
                        // Test Firestore access
                        const db = window.firebaseService.getDB();
                        log('âœ… Firestore acessÃ­vel', 'success');
                        
                        // Test collection access
                        const testQuery = await db.collection('relatorios').limit(1).get();
                        log(`âœ… ColeÃ§Ã£o 'relatorios' acessÃ­vel (${testQuery.size} documentos encontrados)`, 'success');
                        
                    } else {
                        log('âŒ Falha na inicializaÃ§Ã£o do Firebase', 'error');
                    }
                } else {
                    log('âŒ Firebase service nÃ£o encontrado', 'error');
                }
                
            } catch (error) {
                log('âŒ Erro na conexÃ£o: ' + error.message, 'error');
                console.error('Firebase connection error:', error);
            }
        }

        async function testCreateReport() {
            log('ğŸ“ Testando criaÃ§Ã£o de relatÃ³rio...', 'info');
            
            try {
                // Login first
                const authService = new AuthService();
                const loginResult = authService.login('bella_evans', 'sÃ£ocristovÃ£o2016');
                
                if (!loginResult.success) {
                    log('âŒ Erro no login: ' + loginResult.message, 'error');
                    return;
                }
                
                const currentUser = authService.getCurrentUser();
                log(`ğŸ‘¤ Logado como: ${currentUser.name}`, 'info');
                
                // Create test report
                const reportsService = new ReportsService();
                const reportData = {
                    title: 'Teste Firebase - ' + new Date().toLocaleString(),
                    description: 'Este Ã© um relatÃ³rio de teste para verificar a estrutura do Firestore.',
                    missionDate: '2024-12-04',
                    status: 'completed'
                };
                
                log('ğŸ“¤ Criando relatÃ³rio...', 'info');
                const result = await reportsService.createReport(reportData);
                
                if (result.success) {
                    log('âœ… RelatÃ³rio criado com sucesso!', 'success');
                    log(`ğŸ“ ID: ${result.report.id}`, 'success');
                    log(`ğŸ“‹ TÃ­tulo: ${result.report.title}`, 'info');
                    log(`ğŸ‘¤ Autor: ${result.report.authorName}`, 'info');
                } else {
                    log('âŒ Erro ao criar relatÃ³rio: ' + result.message, 'error');
                }
                
            } catch (error) {
                log('âŒ Erro no teste: ' + error.message, 'error');
                console.error('Create report test error:', error);
            }
        }

        async function testLoadReports() {
            log('ğŸ“‹ Testando carregamento de relatÃ³rios...', 'info');
            
            try {
                const authService = new AuthService();
                if (!authService.checkSession()) {
                    authService.login('bella_evans', 'sÃ£ocristovÃ£o2016');
                }
                
                const currentUser = authService.getCurrentUser();
                log(`ğŸ‘¤ Carregando relatÃ³rios para: ${currentUser.name}`, 'info');
                
                const reportsService = new ReportsService();
                const reports = await reportsService.loadReports(currentUser.id);
                
                log(`âœ… Carregados ${reports.length} relatÃ³rios`, 'success');
                
                reports.forEach((report, index) => {
                    log(`   ${index + 1}. ${report.title} (${report.status}) - ${report.authorName}`, 'info');
                });
                
            } catch (error) {
                log('âŒ Erro ao carregar relatÃ³rios: ' + error.message, 'error');
                console.error('Load reports test error:', error);
            }
        }

        async function testShareReport() {
            log('ğŸ”— Testando compartilhamento...', 'info');
            
            try {
                const authService = new AuthService();
                if (!authService.checkSession()) {
                    authService.login('bella_evans', 'sÃ£ocristovÃ£o2016');
                }
                
                const currentUser = authService.getCurrentUser();
                const reportsService = new ReportsService();
                
                // Get user's reports
                const reports = await reportsService.loadReports(currentUser.id);
                
                if (reports.length === 0) {
                    log('âš ï¸ Nenhum relatÃ³rio encontrado para compartilhar', 'warning');
                    return;
                }
                
                const reportToShare = reports[0];
                log(`ğŸ“¤ Compartilhando relatÃ³rio: ${reportToShare.title}`, 'info');
                
                // Share with user_002 (Melissa)
                const shareResult = await reportsService.shareReport(
                    reportToShare.id, 
                    ['user_002'], 
                    currentUser.id
                );
                
                if (shareResult.success) {
                    log('âœ… RelatÃ³rio compartilhado com sucesso!', 'success');
                    log(`ğŸ“ Mensagem: ${shareResult.message}`, 'success');
                } else {
                    log('âŒ Erro ao compartilhar: ' + shareResult.message, 'error');
                }
                
            } catch (error) {
                log('âŒ Erro no teste de compartilhamento: ' + error.message, 'error');
                console.error('Share report test error:', error);
            }
        }

        // Auto-run connection test on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ PÃ¡gina de teste carregada', 'info');
            log('ğŸ“‹ Estrutura do Firestore implementada conforme especificaÃ§Ã£o', 'info');
            
            // Auto-test connection after a short delay
            setTimeout(() => {
                testFirebaseConnection();
            }, 1000);
        });
    </script>
</body>
</html>