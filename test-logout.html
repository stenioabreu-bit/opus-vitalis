<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Logout</title>
    <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body>
    <div class="container">
        <h1>Teste de Logout</h1>
        <div id="message-container"></div>
        
        <div class="form-group">
            <button id="test-login" class="btn btn-primary">Fazer Login de Teste</button>
            <button id="test-logout" class="btn btn-danger">Testar Logout</button>
            <button id="check-session" class="btn btn-secondary">Verificar Sessão</button>
        </div>
        
        <div id="results" style="margin-top: 20px; padding: 20px; background: var(--card-bg); border-radius: 8px;">
            <h3>Resultados:</h3>
            <div id="test-results"></div>
        </div>
    </div>

    <script src="scripts/utils.js"></script>
    <script src="scripts/data-loader.js"></script>
    <script src="scripts/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const authService = new AuthService();
            const resultsDiv = document.getElementById('test-results');
            
            function addResult(message, type = 'info') {
                const p = document.createElement('p');
                p.style.color = type === 'success' ? 'var(--success-green)' : 
                               type === 'error' ? 'var(--error-red)' : 'var(--text-primary)';
                p.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
                resultsDiv.appendChild(p);
            }
            
            // Test login
            document.getElementById('test-login').addEventListener('click', async function() {
                try {
                    addResult('Tentando fazer login...', 'info');
                    const result = await authService.handleLogin('bella_evans', 'sãocristovão2016');
                    
                    if (result.success) {
                        addResult('✓ Login realizado com sucesso!', 'success');
                        addResult(`Usuário logado: ${result.user.name}`, 'info');
                    } else {
                        addResult(`✗ Erro no login: ${result.message}`, 'error');
                    }
                } catch (error) {
                    addResult(`✗ Erro no login: ${error.message}`, 'error');
                }
            });
            
            // Test logout
            document.getElementById('test-logout').addEventListener('click', function() {
                try {
                    addResult('Tentando fazer logout...', 'info');
                    
                    // Check if user is logged in first
                    const currentUser = authService.getCurrentUser();
                    if (!currentUser) {
                        addResult('✗ Nenhum usuário logado para fazer logout', 'error');
                        return;
                    }
                    
                    addResult(`Usuário atual: ${currentUser.name}`, 'info');
                    
                    // Override window.location.href to prevent actual redirect during test
                    const originalLocation = window.location.href;
                    let redirectUrl = null;
                    
                    Object.defineProperty(window.location, 'href', {
                        set: function(url) {
                            redirectUrl = url;
                            addResult(`✓ Redirecionamento para: ${url}`, 'success');
                        },
                        get: function() {
                            return originalLocation;
                        }
                    });
                    
                    // Perform logout
                    authService.handleLogout();
                    
                    // Check if session was cleared
                    const sessionAfterLogout = authService.checkSession();
                    const userAfterLogout = authService.getCurrentUser();
                    
                    if (!sessionAfterLogout && !userAfterLogout && redirectUrl === 'login.html') {
                        addResult('✓ Logout realizado com sucesso!', 'success');
                        addResult('✓ Sessão limpa corretamente', 'success');
                        addResult('✓ Redirecionamento correto para login', 'success');
                    } else {
                        addResult('✗ Problemas no logout:', 'error');
                        addResult(`  - Sessão ativa: ${sessionAfterLogout}`, 'error');
                        addResult(`  - Usuário atual: ${userAfterLogout ? userAfterLogout.name : 'null'}`, 'error');
                        addResult(`  - URL de redirecionamento: ${redirectUrl}`, 'error');
                    }
                    
                } catch (error) {
                    addResult(`✗ Erro no logout: ${error.message}`, 'error');
                }
            });
            
            // Check session
            document.getElementById('check-session').addEventListener('click', function() {
                const hasSession = authService.checkSession();
                const currentUser = authService.getCurrentUser();
                
                addResult(`Sessão ativa: ${hasSession}`, hasSession ? 'success' : 'info');
                addResult(`Usuário atual: ${currentUser ? currentUser.name : 'Nenhum'}`, currentUser ? 'success' : 'info');
                
                if (hasSession && currentUser) {
                    addResult(`ID: ${currentUser.id}`, 'info');
                    addResult(`Role: ${currentUser.role}`, 'info');
                    addResult(`Team: ${currentUser.team}`, 'info');
                }
            });
            
            // Initial session check
            addResult('Página carregada. Verificando sessão inicial...', 'info');
            document.getElementById('check-session').click();
        });
    </script>
</body>
</html>