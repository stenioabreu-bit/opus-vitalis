<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ordem Paranormal - Dashboard</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <style>
        .dashboard-header {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .welcome-message h2 {
            color: var(--accent-blue);
            margin-bottom: 5px;
        }
        
        .nav-menu {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .nav-menu .btn {
            min-width: 150px;
        }
        
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            color: var(--accent-blue);
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .recent-activity {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .nav-menu {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="dashboard-header">
            <div class="welcome-message">
                <h2>Bem-vindo, <span id="user-name">Agente</span></h2>
                <p style="color: var(--text-secondary);">Central de Comando - Ordem Paranormal</p>
            </div>
            
            <div class="nav-menu" id="nav-menu">
                <a href="create-report.html" class="btn btn-primary">Criar Relatório</a>
                <a href="reports.html" class="btn btn-secondary">Meus Relatórios</a>
                <a href="shared-reports.html" class="btn btn-secondary">Relatórios Compartilhados</a>
                <a href="team-reports.html" class="btn btn-secondary" id="team-reports-link" style="display: none;">Relatórios da Equipe</a>
                <button id="logout-btn" class="btn btn-danger">Sair</button>
            </div>
        </div>
        
        <div id="message-container"></div>
        
        <div class="quick-stats">
            <div class="stat-card">
                <div class="stat-number" id="total-reports">0</div>
                <div>Relatórios Criados</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number" id="shared-reports">0</div>
                <div>Relatórios Compartilhados</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number" id="team-reports">0</div>
                <div>Relatórios da Equipe</div>
            </div>
        </div>
        
        <div class="recent-activity">
            <h3 style="color: var(--accent-blue); margin-bottom: 20px;">Atividade Recente</h3>
            <div id="recent-activity-list">
                <p style="color: var(--text-secondary); text-align: center;">
                    Nenhuma atividade recente encontrada.
                </p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="scripts/utils.js"></script>
    <script src="scripts/auth.js"></script>
    <script src="scripts/reports.js"></script>
    <script src="scripts/teams.js"></script>
    <script>
        // Dashboard functionality class
        class DashboardController {
            constructor() {
                this.authService = new AuthService();
                this.reportsService = new ReportsService();
                this.teamsService = new TeamsService();
                this.currentUser = null;
            }

            // Initialize dashboard
            async init() {
                // Check authentication and redirect if not logged in
                if (!this.authService.checkSession()) {
                    this.redirectToLogin();
                    return;
                }

                this.currentUser = this.authService.getCurrentUser();
                if (!this.currentUser) {
                    this.redirectToLogin();
                    return;
                }

                // Setup UI
                this.setupUserInterface();
                this.setupNavigationHandlers();
                this.setupLogoutHandler();
                
                // Load dashboard data
                await this.loadDashboardData();
            }

            // Redirect to login page
            redirectToLogin() {
                window.location.href = 'login.html';
            }

            // Setup user interface elements
            setupUserInterface() {
                const userNameElement = document.getElementById('user-name');
                if (userNameElement && this.currentUser) {
                    userNameElement.textContent = this.currentUser.name || this.currentUser.username;
                }
                
                // Show team reports link only for leaders
                const teamReportsLink = document.getElementById('team-reports-link');
                if (teamReportsLink && this.currentUser && this.currentUser.role === 'leader') {
                    teamReportsLink.style.display = 'inline-block';
                }
            }

            // Setup navigation handlers for page routing
            setupNavigationHandlers() {
                // Navigation links are already set up as anchor tags in HTML
                // They will handle routing automatically
                
                // Add click handlers for any additional navigation logic if needed
                const navLinks = document.querySelectorAll('.nav-menu a');
                navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        // Add any pre-navigation logic here if needed
                        console.log('Navigating to:', link.href);
                    });
                });
            }

            // Setup logout functionality
            setupLogoutHandler() {
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.handleLogout();
                    });
                }
            }

            // Handle logout with confirmation
            handleLogout() {
                if (confirm('Tem certeza que deseja sair?')) {
                    try {
                        this.authService.handleLogout();
                    } catch (error) {
                        console.error('Error during logout:', error);
                        Utils.showMessage('Erro ao fazer logout. Redirecionando...', 'error');
                        // Force redirect even if logout fails
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 2000);
                    }
                }
            }

            // Load and display dashboard data
            async loadDashboardData() {
                try {
                    // Show loading state
                    this.showLoadingStats();

                    // Load data from services
                    // Load user and shared reports
                    const [userReports, sharedReports] = await Promise.all([
                        this.reportsService.loadReports(this.currentUser.id),
                        this.reportsService.loadSharedReports(this.currentUser.id)
                    ]);
                    
                    // Load team reports only for leaders
                    let teamReports = [];
                    if (this.currentUser.role === 'leader') {
                        const teamResult = await this.teamsService.getTeamReports(this.currentUser.id);
                        teamReports = teamResult.success ? teamResult.reports : [];
                    }

                    // Update statistics
                    this.updateStats(userReports, sharedReports, teamReports);
                    
                    // Update recent activity
                    this.updateRecentActivity(userReports, sharedReports);

                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                    Utils.showMessage('Erro ao carregar dados do dashboard.', 'error');
                    
                    // Set default values on error
                    this.updateStats([], [], []);
                }
            }

            // Show loading state for statistics
            showLoadingStats() {
                const statElements = ['total-reports', 'shared-reports', 'team-reports'];
                statElements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.innerHTML = '<span class="loading"></span>';
                    }
                });
            }

            // Update dashboard statistics
            updateStats(userReports, sharedReports, teamReports) {
                const totalReportsElement = document.getElementById('total-reports');
                const sharedReportsElement = document.getElementById('shared-reports');
                const teamReportsElement = document.getElementById('team-reports');

                if (totalReportsElement) {
                    totalReportsElement.textContent = userReports.length.toString();
                }
                
                if (sharedReportsElement) {
                    sharedReportsElement.textContent = sharedReports.length.toString();
                }
                
                if (teamReportsElement) {
                    teamReportsElement.textContent = teamReports.length.toString();
                }
            }

            // Update recent activity section
            updateRecentActivity(userReports, sharedReports) {
                const activityList = document.getElementById('recent-activity-list');
                if (!activityList) return;

                // Combine and sort all reports by date
                const allReports = [...userReports, ...sharedReports]
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                    .slice(0, 5); // Show only 5 most recent

                if (allReports.length === 0) {
                    activityList.innerHTML = `
                        <p style="color: var(--text-secondary); text-align: center;">
                            Nenhuma atividade recente encontrada.
                        </p>
                    `;
                    return;
                }

                // Generate activity HTML
                const activityHTML = allReports.map(report => `
                    <div style="padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                        <div style="color: var(--accent-blue); font-weight: 500;">
                            ${Utils.sanitizeHtml(report.title)}
                        </div>
                        <div style="color: var(--text-secondary); font-size: 0.9em;">
                            ${report.authorId === this.currentUser.id ? 'Criado' : 'Compartilhado'} em ${Utils.formatDate(report.createdAt)}
                        </div>
                    </div>
                `).join('');

                activityList.innerHTML = activityHTML;
            }

            // Verify user session periodically
            startSessionVerification() {
                // Check session every 5 minutes
                setInterval(() => {
                    if (!this.authService.checkSession()) {
                        Utils.showMessage('Sessão expirada. Redirecionando para login...', 'error');
                        setTimeout(() => {
                            this.redirectToLogin();
                        }, 2000);
                    }
                }, 5 * 60 * 1000);
            }
        }

        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', async function() {
            const dashboard = new DashboardController();
            await dashboard.init();
            dashboard.startSessionVerification();
        });
    </script>
</body>
</html>