<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Simples - Criar Relat√≥rio</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 30px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        
        .test-section {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 4px;
            margin: 20px 0;
        }
        
        .test-button {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        
        .test-button:hover {
            background: #0099cc;
        }
        
        .status {
            font-family: monospace;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .success { color: var(--success-green); }
        .error { color: var(--error-red); }
        .warning { color: #ffa500; }
        
        .form-simple {
            display: grid;
            gap: 15px;
            margin: 20px 0;
        }
        
        .form-simple input, .form-simple textarea, .form-simple select {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 style="color: var(--accent-blue); text-align: center;">
            üß™ Teste Simples - Criar Relat√≥rio
        </h1>
        
        <div class="test-section">
            <h3>1. Verifica√ß√£o de Autentica√ß√£o</h3>
            <div id="auth-status" class="status">Aguardando verifica√ß√£o...</div>
            <button class="test-button" onclick="checkAuth()">Verificar Autentica√ß√£o</button>
            <button class="test-button" onclick="forceLogin()">For√ßar Login (bella_evans)</button>
        </div>
        
        <div class="test-section">
            <h3>2. Teste de Cria√ß√£o de Relat√≥rio</h3>
            
            <div class="form-simple">
                <input type="text" id="title" placeholder="T√≠tulo do relat√≥rio" value="Teste Simples">
                <textarea id="description" placeholder="Descri√ß√£o" rows="3">Relat√≥rio de teste para verificar funcionamento.</textarea>
                <input type="date" id="missionDate" value="">
                <select id="status">
                    <option value="completed">Conclu√≠da</option>
                    <option value="partial">Parcial</option>
                    <option value="failed">Falhou</option>
                </select>
            </div>
            
            <div id="create-status" class="status">Aguardando teste...</div>
            <button class="test-button" onclick="testCreateReport()">Criar Relat√≥rio de Teste</button>
        </div>
        
        <div class="test-section">
            <h3>3. Verifica√ß√£o de Relat√≥rios</h3>
            <div id="reports-status" class="status">Aguardando verifica√ß√£o...</div>
            <button class="test-button" onclick="checkReports()">Verificar Relat√≥rios</button>
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
            <a href="create-report.html" class="btn btn-primary">Ir para Criar Relat√≥rio</a>
            <a href="dashboard.html" class="btn btn-secondary">Dashboard</a>
        </div>
    </div>

    <!-- Scripts -->
    <script src="scripts/utils.js"></script>
    <script src="scripts/auth.js"></script>
    <script src="scripts/data-loader.js"></script>
    <script src="scripts/reports.js"></script>
    
    <script>
        let authService, reportsService;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date
            document.getElementById('missionDate').value = new Date().toISOString().split('T')[0];
            
            // Initialize services
            authService = new AuthService();
            window.authServiceInstance = authService; // Share globally
            reportsService = new ReportsService();
            
            // Auto-check auth
            setTimeout(checkAuth, 500);
        });
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            
            element.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            element.scrollTop = element.scrollHeight;
        }
        
        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }
        
        function checkAuth() {
            clearLog('auth-status');
            log('auth-status', 'Verificando autentica√ß√£o...', 'info');
            
            try {
                // Check session
                const hasSession = authService.checkSession();
                log('auth-status', `Sess√£o ativa: ${hasSession}`, hasSession ? 'success' : 'warning');
                
                // Get current user
                const currentUser = authService.getCurrentUser();
                if (currentUser) {
                    log('auth-status', `‚úÖ Usu√°rio logado: ${currentUser.username}`, 'success');
                    log('auth-status', `   Nome: ${currentUser.name}`, 'info');
                    log('auth-status', `   ID: ${currentUser.id}`, 'info');
                    log('auth-status', `   Role: ${currentUser.role}`, 'info');
                } else {
                    log('auth-status', '‚ùå Nenhum usu√°rio logado', 'error');
                }
                
                // Check localStorage
                const sessionData = localStorage.getItem('opus_vitalis_session');
                if (sessionData) {
                    log('auth-status', '‚úÖ Dados de sess√£o no localStorage', 'success');
                    try {
                        const parsed = JSON.parse(sessionData);
                        log('auth-status', `   Usu√°rio no storage: ${parsed.username}`, 'info');
                    } catch (e) {
                        log('auth-status', '‚ùå Dados corrompidos no localStorage', 'error');
                    }
                } else {
                    log('auth-status', '‚ùå Nenhum dado no localStorage', 'error');
                }
                
            } catch (error) {
                log('auth-status', `‚ùå ERRO: ${error.message}`, 'error');
            }
        }
        
        function forceLogin() {
            clearLog('auth-status');
            log('auth-status', 'For√ßando login para bella_evans...', 'info');
            
            try {
                // Create user data
                const userData = {
                    id: "user_001",
                    username: "bella_evans",
                    name: "Bella Evans",
                    role: "agent",
                    team: "lideran√ßa_opus"
                };
                
                // Set in auth service
                authService.currentUser = userData;
                
                // Save to localStorage
                localStorage.setItem('opus_vitalis_session', JSON.stringify(userData));
                
                log('auth-status', '‚úÖ Login for√ßado com sucesso!', 'success');
                log('auth-status', `   Usu√°rio: ${userData.username}`, 'success');
                log('auth-status', '   Verificando...', 'info');
                
                // Verify
                setTimeout(() => {
                    const verified = authService.checkSession();
                    const user = authService.getCurrentUser();
                    
                    if (verified && user) {
                        log('auth-status', '‚úÖ Verifica√ß√£o OK - Login funcionando!', 'success');
                    } else {
                        log('auth-status', '‚ùå Verifica√ß√£o falhou', 'error');
                    }
                }, 100);
                
            } catch (error) {
                log('auth-status', `‚ùå ERRO: ${error.message}`, 'error');
            }
        }
        
        async function testCreateReport() {
            clearLog('create-status');
            log('create-status', 'Testando cria√ß√£o de relat√≥rio...', 'info');
            
            try {
                // Check auth first
                const currentUser = authService.getCurrentUser();
                if (!currentUser) {
                    log('create-status', '‚ùå ERRO: Usu√°rio n√£o autenticado', 'error');
                    log('create-status', '   Execute "For√ßar Login" primeiro', 'warning');
                    return;
                }
                
                log('create-status', `‚úÖ Usu√°rio autenticado: ${currentUser.username}`, 'success');
                
                // Get form data
                const reportData = {
                    title: document.getElementById('title').value.trim(),
                    description: document.getElementById('description').value.trim(),
                    missionDate: document.getElementById('missionDate').value,
                    status: document.getElementById('status').value
                };
                
                log('create-status', 'Dados do relat√≥rio:', 'info');
                log('create-status', `   T√≠tulo: ${reportData.title}`, 'info');
                log('create-status', `   Data: ${reportData.missionDate}`, 'info');
                log('create-status', `   Status: ${reportData.status}`, 'info');
                
                // Validate
                if (!reportData.title || !reportData.description || !reportData.missionDate || !reportData.status) {
                    log('create-status', '‚ùå ERRO: Preencha todos os campos', 'error');
                    return;
                }
                
                // Create report
                log('create-status', 'Chamando reportsService.createReport()...', 'info');
                const result = await reportsService.createReport(reportData);
                
                if (result.success) {
                    log('create-status', 'üéâ SUCESSO! Relat√≥rio criado!', 'success');
                    log('create-status', `   ID: ${result.report.id}`, 'success');
                    log('create-status', `   Autor: ${result.report.authorName}`, 'info');
                    log('create-status', `   Criado em: ${result.report.createdAt}`, 'info');
                } else {
                    log('create-status', `‚ùå ERRO: ${result.message}`, 'error');
                }
                
            } catch (error) {
                log('create-status', `‚ùå ERRO CR√çTICO: ${error.message}`, 'error');
                console.error('Create report error:', error);
            }
        }
        
        async function checkReports() {
            clearLog('reports-status');
            log('reports-status', 'Verificando relat√≥rios...', 'info');
            
            try {
                const currentUser = authService.getCurrentUser();
                if (!currentUser) {
                    log('reports-status', '‚ùå ERRO: Usu√°rio n√£o autenticado', 'error');
                    return;
                }
                
                // Get all reports
                const allReports = await reportsService.getAllReports();
                log('reports-status', `Total de relat√≥rios: ${Object.keys(allReports).length}`, 'info');
                
                // Get user reports
                const userReports = await reportsService.loadReports(currentUser.id);
                log('reports-status', `Relat√≥rios do usu√°rio: ${userReports.length}`, 'info');
                
                if (userReports.length > 0) {
                    log('reports-status', 'Relat√≥rios encontrados:', 'success');
                    userReports.forEach((report, index) => {
                        log('reports-status', `   ${index + 1}. "${report.title}" (${report.status})`, 'info');
                    });
                } else {
                    log('reports-status', 'Nenhum relat√≥rio encontrado para este usu√°rio', 'warning');
                }
                
                // Check localStorage
                const localReports = reportsService.getLocalReports();
                log('reports-status', `Relat√≥rios no localStorage: ${Object.keys(localReports).length}`, 'info');
                
            } catch (error) {
                log('reports-status', `‚ùå ERRO: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>