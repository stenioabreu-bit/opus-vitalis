<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Gerenciamento de UsuÃ¡rios</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <style>
        .test-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .log {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .success { color: var(--success-green); }
        .error { color: var(--error-red); }
        .info { color: var(--text-primary); }
        .warning { color: var(--warning-orange); }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Teste - Sistema de Gerenciamento de UsuÃ¡rios</h1>
        
        <div class="test-section">
            <h2>ğŸ”§ Testes do Sistema</h2>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="testUserManager()">
                    ğŸ‘¤ Testar UserManager
                </button>
                <button class="btn btn-secondary" onclick="testMigration()">
                    ğŸ”„ Testar MigraÃ§Ã£o
                </button>
                <button class="btn btn-secondary" onclick="testAuth()">
                    ğŸ” Testar AutenticaÃ§Ã£o
                </button>
                <button class="btn btn-danger" onclick="clearLog()">
                    ğŸ—‘ï¸ Limpar Log
                </button>
            </div>
            <div id="test-log" class="log"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    
    <script src="scripts/utils.js"></script>
    <script src="scripts/auth.js"></script>
    <script src="scripts/data-loader.js"></script>
    <script src="scripts/firebase.js"></script>
    <script src="scripts/user-manager.js"></script>
    
    <script>
        function log(message, type = 'info') {
            const logEl = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('test-log').textContent = '';
        }

        async function testUserManager() {
            clearLog();
            log('ğŸ§ª Testando UserManager...', 'info');
            
            try {
                // 1. Initialize UserManager
                log('1ï¸âƒ£ Inicializando UserManager...', 'info');
                const userManager = new UserManager();
                await userManager.init();
                log('âœ… UserManager inicializado', 'success');
                
                // 2. Get all users
                log('2ï¸âƒ£ Carregando usuÃ¡rios...', 'info');
                const users = await userManager.getAllUsers();
                log(`âœ… ${users.length} usuÃ¡rios encontrados`, 'success');
                
                users.forEach((user, index) => {
                    log(`   ${index + 1}. ${user.name} (${user.username}) - ${user.role}`, 'info');
                });
                
                // 3. Test user creation
                log('3ï¸âƒ£ Testando criaÃ§Ã£o de usuÃ¡rio...', 'info');
                const testUser = {
                    name: 'UsuÃ¡rio Teste',
                    username: 'teste_' + Date.now(),
                    password: 'senha123',
                    role: 'agent',
                    team: 'teste_team'
                };
                
                const createResult = await userManager.createUser(testUser);
                if (createResult.success) {
                    log('âœ… UsuÃ¡rio de teste criado: ' + createResult.user.id, 'success');
                    
                    // 4. Test user update
                    log('4ï¸âƒ£ Testando atualizaÃ§Ã£o de usuÃ¡rio...', 'info');
                    const updateResult = await userManager.updateUser(createResult.user.id, {
                        name: 'UsuÃ¡rio Teste Atualizado',
                        role: 'leader'
                    });
                    
                    if (updateResult.success) {
                        log('âœ… UsuÃ¡rio atualizado com sucesso', 'success');
                        
                        // 5. Test user deletion
                        log('5ï¸âƒ£ Testando exclusÃ£o de usuÃ¡rio...', 'info');
                        const deleteResult = await userManager.deleteUser(createResult.user.id);
                        
                        if (deleteResult.success) {
                            log('âœ… UsuÃ¡rio excluÃ­do com sucesso', 'success');
                        } else {
                            log('âŒ Erro ao excluir usuÃ¡rio: ' + deleteResult.message, 'error');
                        }
                    } else {
                        log('âŒ Erro ao atualizar usuÃ¡rio: ' + updateResult.message, 'error');
                    }
                } else {
                    log('âŒ Erro ao criar usuÃ¡rio: ' + createResult.message, 'error');
                }
                
                log('ğŸ¯ Teste do UserManager concluÃ­do!', 'success');
                
            } catch (error) {
                log('âŒ Erro durante teste: ' + error.message, 'error');
                console.error('Test error:', error);
            }
        }

        async function testMigration() {
            log('ğŸ”„ Testando migraÃ§Ã£o de usuÃ¡rios...', 'info');
            
            try {
                const userManager = new UserManager();
                await userManager.init();
                
                const users = await userManager.getAllUsers();
                log(`ğŸ“Š Total de usuÃ¡rios apÃ³s migraÃ§Ã£o: ${users.length}`, 'info');
                
                if (users.length > 0) {
                    log('âœ… MigraÃ§Ã£o bem-sucedida!', 'success');
                    users.forEach(user => {
                        const migrated = user.migrated ? ' (migrado)' : '';
                        log(`   ğŸ‘¤ ${user.name} - ${user.username}${migrated}`, 'info');
                    });
                } else {
                    log('âš ï¸ Nenhum usuÃ¡rio encontrado apÃ³s migraÃ§Ã£o', 'warning');
                }
                
            } catch (error) {
                log('âŒ Erro na migraÃ§Ã£o: ' + error.message, 'error');
            }
        }

        async function testAuth() {
            log('ğŸ” Testando sistema de autenticaÃ§Ã£o...', 'info');
            
            try {
                const authService = new AuthService();
                
                // Test with existing user
                log('1ï¸âƒ£ Testando login com usuÃ¡rio existente...', 'info');
                const loginResult = await authService.login('bella_evans', 'sÃ£ocristovÃ£o2016');
                
                if (loginResult.success) {
                    log('âœ… Login realizado com sucesso!', 'success');
                    
                    const currentUser = authService.getCurrentUser();
                    log(`ğŸ‘¤ UsuÃ¡rio logado: ${currentUser.name} (${currentUser.role})`, 'info');
                    
                    // Test logout
                    log('2ï¸âƒ£ Testando logout...', 'info');
                    authService.logout();
                    
                    const userAfterLogout = authService.getCurrentUser();
                    if (!userAfterLogout) {
                        log('âœ… Logout realizado com sucesso!', 'success');
                    } else {
                        log('âŒ Erro no logout', 'error');
                    }
                } else {
                    log('âŒ Erro no login: ' + loginResult.message, 'error');
                }
                
                log('ğŸ¯ Teste de autenticaÃ§Ã£o concluÃ­do!', 'success');
                
            } catch (error) {
                log('âŒ Erro durante teste de auth: ' + error.message, 'error');
                console.error('Auth test error:', error);
            }
        }

        // Auto-run tests on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ PÃ¡gina de teste carregada', 'info');
            log('ğŸ“‹ Sistema de gerenciamento de usuÃ¡rios implementado', 'info');
            log('ğŸ”§ Clique nos botÃµes para executar os testes', 'info');
        });
    </script>
</body>
</html>