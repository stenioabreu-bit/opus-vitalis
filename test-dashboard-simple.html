<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Simples do Dashboard</title>
    <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body>
    <div class="container">
        <div style="background: var(--card-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h1 style="color: var(--accent-blue);">Teste Simples do Dashboard</h1>
            <p style="color: var(--text-secondary);">Simulação simplificada do dashboard para testar o logout</p>
        </div>
        
        <div id="message-container"></div>
        
        <!-- Simulação da barra de navegação do dashboard -->
        <div style="background: var(--card-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h2 style="color: var(--accent-blue); margin: 0;">Bem-vindo, <span id="user-name">Agente</span></h2>
                <p style="color: var(--text-secondary); margin: 0;">Central de Comando - Ordem Paranormal</p>
            </div>
            
            <div style="display: flex; gap: 15px;">
                <button class="btn btn-primary">Criar Relatório</button>
                <button class="btn btn-secondary">Meus Relatórios</button>
                <button id="logout-btn" class="btn btn-danger">Sair</button>
            </div>
        </div>
        
        <!-- Controles de teste -->
        <div style="background: var(--card-bg); padding: 20px; border-radius: 8px;">
            <h3 style="color: var(--accent-blue);">Controles de Teste</h3>
            
            <div class="form-group">
                <button id="login-first" class="btn btn-primary">1. Fazer Login</button>
                <button id="check-status" class="btn btn-secondary">2. Verificar Status</button>
                <button id="test-logout-direct" class="btn btn-danger">3. Testar Logout Direto</button>
            </div>
            
            <div style="margin-top: 20px;">
                <h4 style="color: var(--accent-blue);">Status:</h4>
                <div id="status-display" style="font-family: monospace; background: var(--bg-secondary); padding: 10px; border-radius: 4px;"></div>
            </div>
        </div>
    </div>

    <script src="scripts/utils.js"></script>
    <script src="scripts/data-loader.js"></script>
    <script src="scripts/auth.js"></script>
    <script>
        let authService;
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status-display');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'success' ? 'var(--success-green)' : 
                         type === 'error' ? 'var(--error-red)' : 'var(--text-primary)';
            
            statusDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            statusDiv.scrollTop = statusDiv.scrollHeight;
        }
        
        function updateUserDisplay() {
            const userNameSpan = document.getElementById('user-name');
            
            if (authService && authService.checkSession()) {
                const user = authService.getCurrentUser();
                if (user) {
                    userNameSpan.textContent = user.name || user.username;
                    userNameSpan.style.color = 'var(--success-green)';
                } else {
                    userNameSpan.textContent = 'Erro na Sessão';
                    userNameSpan.style.color = 'var(--error-red)';
                }
            } else {
                userNameSpan.textContent = 'Não Logado';
                userNameSpan.style.color = 'var(--text-secondary)';
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            authService = new AuthService();
            
            updateStatus('Sistema inicializado');
            updateUserDisplay();
            
            // Setup logout button (exactly like in dashboard)
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                updateStatus('✓ Botão de logout encontrado');
                
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    updateStatus('Botão de logout clicado');
                    
                    if (confirm('Tem certeza que deseja sair?')) {
                        updateStatus('Usuário confirmou logout');
                        
                        try {
                            // Override redirect for testing
                            let redirectUrl = null;
                            const originalHref = window.location.href;
                            
                            Object.defineProperty(window.location, 'href', {
                                set: function(url) {
                                    redirectUrl = url;
                                    updateStatus(`Redirecionamento: ${url}`, 'success');
                                },
                                get: function() {
                                    return originalHref;
                                },
                                configurable: true
                            });
                            
                            // Perform logout
                            authService.handleLogout();
                            
                            // Check results
                            setTimeout(() => {
                                const sessionAfter = authService.checkSession();
                                const userAfter = authService.getCurrentUser();
                                
                                if (!sessionAfter && !userAfter) {
                                    updateStatus('✓ Logout executado com sucesso!', 'success');
                                } else {
                                    updateStatus('✗ Problemas no logout', 'error');
                                }
                                
                                updateUserDisplay();
                            }, 100);
                            
                        } catch (error) {
                            updateStatus(`✗ Erro no logout: ${error.message}`, 'error');
                        }
                    } else {
                        updateStatus('Usuário cancelou logout');
                    }
                });
            } else {
                updateStatus('✗ Botão de logout NÃO encontrado!', 'error');
            }
            
            // Test controls
            document.getElementById('login-first').addEventListener('click', async function() {
                try {
                    updateStatus('Fazendo login...');
                    const result = await authService.handleLogin('bella_evans', 'sãocristovão2016');
                    
                    if (result.success) {
                        updateStatus('✓ Login realizado com sucesso!', 'success');
                        updateUserDisplay();
                    } else {
                        updateStatus(`✗ Erro no login: ${result.message}`, 'error');
                    }
                } catch (error) {
                    updateStatus(`✗ Erro no login: ${error.message}`, 'error');
                }
            });
            
            document.getElementById('check-status').addEventListener('click', function() {
                const hasSession = authService.checkSession();
                const currentUser = authService.getCurrentUser();
                
                updateStatus(`Sessão ativa: ${hasSession}`, hasSession ? 'success' : 'info');
                updateStatus(`Usuário: ${currentUser ? currentUser.name : 'Nenhum'}`, currentUser ? 'success' : 'info');
                
                updateUserDisplay();
            });
            
            document.getElementById('test-logout-direct').addEventListener('click', function() {
                updateStatus('Testando logout direto (sem confirmação)...');
                
                if (!authService.checkSession()) {
                    updateStatus('⚠ Faça login primeiro!', 'error');
                    return;
                }
                
                try {
                    // Override redirect for testing
                    let redirectUrl = null;
                    const originalHref = window.location.href;
                    
                    Object.defineProperty(window.location, 'href', {
                        set: function(url) {
                            redirectUrl = url;
                            updateStatus(`Redirecionamento direto: ${url}`, 'success');
                        },
                        get: function() {
                            return originalHref;
                        },
                        configurable: true
                    });
                    
                    // Call logout directly
                    authService.handleLogout();
                    
                    setTimeout(() => {
                        const sessionAfter = authService.checkSession();
                        const userAfter = authService.getCurrentUser();
                        
                        if (!sessionAfter && !userAfter && redirectUrl === 'login.html') {
                            updateStatus('✓ Logout direto funcionou!', 'success');
                        } else {
                            updateStatus('✗ Logout direto com problemas', 'error');
                        }
                        
                        updateUserDisplay();
                    }, 100);
                    
                } catch (error) {
                    updateStatus(`✗ Erro no logout direto: ${error.message}`, 'error');
                }
            });
        });
    </script>
</body>
</html>