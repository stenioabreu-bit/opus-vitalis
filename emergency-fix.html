<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CorreÃ§Ã£o Emergencial - Opus Vitalis</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <style>
        .emergency-container {
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            background: var(--card-bg);
            border: 2px solid var(--error-red);
            border-radius: 8px;
            text-align: center;
        }
        
        .emergency-title {
            color: var(--error-red);
            font-size: 2em;
            margin-bottom: 20px;
        }
        
        .emergency-button {
            background: var(--error-red);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 4px;
            font-size: 1.1em;
            cursor: pointer;
            margin: 10px;
            transition: background 0.3s ease;
        }
        
        .emergency-button:hover {
            background: #cc0000;
        }
        
        .emergency-button.success {
            background: var(--success-green);
        }
        
        .emergency-button.success:hover {
            background: #4a7c59;
        }
        
        .status-message {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            font-family: monospace;
            text-align: left;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .success { color: var(--success-green); }
        .error { color: var(--error-red); }
        .warning { color: #ffa500; }
    </style>
</head>
<body>
    <div class="emergency-container">
        <h1 class="emergency-title">ðŸš¨ CorreÃ§Ã£o Emergencial</h1>
        
        <p style="color: var(--text-secondary); margin-bottom: 30px;">
            Esta ferramenta vai limpar completamente o sistema e reinicializar tudo do zero.
        </p>
        
        <div id="status" class="status-message">
            Aguardando aÃ§Ã£o do usuÃ¡rio...
        </div>
        
        <button class="emergency-button" onclick="emergencyReset()">
            ðŸ”¥ RESET COMPLETO DO SISTEMA
        </button>
        
        <button class="emergency-button success" onclick="testLogin()" style="display: none;" id="test-login-btn">
            âœ… TESTAR LOGIN
        </button>
        
        <div style="margin-top: 30px;">
            <a href="login.html" class="btn btn-primary">Ir para Login</a>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const status = document.getElementById('status');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            
            status.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            status.scrollTop = status.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('status').innerHTML = '';
        }
        
        function emergencyReset() {
            clearLog();
            log('ðŸš¨ INICIANDO RESET EMERGENCIAL...', 'warning');
            
            try {
                // 1. Limpar TUDO do localStorage
                log('1. Limpando localStorage...', 'info');
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    keysToRemove.push(localStorage.key(i));
                }
                
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                    log(`   Removido: ${key}`, 'success');
                });
                
                log('âœ… localStorage completamente limpo!', 'success');
                
                // 2. Limpar sessionStorage tambÃ©m
                log('2. Limpando sessionStorage...', 'info');
                sessionStorage.clear();
                log('âœ… sessionStorage limpo!', 'success');
                
                // 3. Criar sessÃ£o de teste limpa
                log('3. Criando sessÃ£o de teste...', 'info');
                const testUser = {
                    id: "user_001",
                    username: "bella_evans",
                    name: "Bella Evans",
                    role: "agent",
                    team: "lideranÃ§a_opus"
                };
                
                localStorage.setItem('opus_vitalis_session', JSON.stringify(testUser));
                log('âœ… SessÃ£o de teste criada para bella_evans', 'success');
                
                // 4. Verificar se a sessÃ£o foi salva corretamente
                log('4. Verificando sessÃ£o...', 'info');
                const savedSession = localStorage.getItem('opus_vitalis_session');
                if (savedSession) {
                    const parsed = JSON.parse(savedSession);
                    log(`âœ… SessÃ£o verificada: ${parsed.username} (${parsed.name})`, 'success');
                } else {
                    log('âŒ ERRO: SessÃ£o nÃ£o foi salva!', 'error');
                    return;
                }
                
                log('', 'info');
                log('ðŸŽ‰ RESET EMERGENCIAL CONCLUÃDO!', 'success');
                log('', 'info');
                log('Agora vocÃª pode:', 'info');
                log('1. Testar o login clicando no botÃ£o abaixo', 'info');
                log('2. Ou ir direto para o dashboard (jÃ¡ estÃ¡ logado)', 'info');
                
                // Mostrar botÃ£o de teste
                document.getElementById('test-login-btn').style.display = 'inline-block';
                
            } catch (error) {
                log(`âŒ ERRO CRÃTICO: ${error.message}`, 'error');
                log('Tente recarregar a pÃ¡gina e executar novamente.', 'warning');
            }
        }
        
        async function testLogin() {
            clearLog();
            log('ðŸ§ª TESTANDO SISTEMA APÃ“S RESET...', 'info');
            
            try {
                // Verificar se os scripts estÃ£o carregados
                log('1. Verificando scripts...', 'info');
                
                // Carregar scripts dinamicamente se necessÃ¡rio
                if (typeof AuthService === 'undefined') {
                    log('   Carregando AuthService...', 'info');
                    await loadScript('scripts/auth.js');
                }
                
                if (typeof DataLoader === 'undefined') {
                    log('   Carregando DataLoader...', 'info');
                    await loadScript('scripts/data-loader.js');
                }
                
                if (typeof ReportsService === 'undefined') {
                    log('   Carregando ReportsService...', 'info');
                    await loadScript('scripts/reports.js');
                }
                
                log('âœ… Scripts carregados', 'success');
                
                // 2. Testar AuthService
                log('2. Testando AuthService...', 'info');
                const authService = new AuthService();
                const hasSession = authService.checkSession();
                log(`   SessÃ£o ativa: ${hasSession}`, hasSession ? 'success' : 'error');
                
                if (hasSession) {
                    const currentUser = authService.getCurrentUser();
                    log(`   UsuÃ¡rio: ${currentUser.username} (${currentUser.name})`, 'success');
                }
                
                // 3. Testar criaÃ§Ã£o de relatÃ³rio
                log('3. Testando criaÃ§Ã£o de relatÃ³rio...', 'info');
                const reportsService = new ReportsService();
                
                const testReportData = {
                    title: 'Teste Emergencial - ' + new Date().toLocaleString(),
                    description: 'RelatÃ³rio criado apÃ³s reset emergencial para verificar funcionamento.',
                    missionDate: new Date().toISOString().split('T')[0],
                    status: 'completed'
                };
                
                const result = await reportsService.createReport(testReportData);
                
                if (result.success) {
                    log('âœ… RELATÃ“RIO CRIADO COM SUCESSO!', 'success');
                    log(`   ID: ${result.report.id}`, 'info');
                    log(`   TÃ­tulo: ${result.report.title}`, 'info');
                } else {
                    log(`âŒ ERRO ao criar relatÃ³rio: ${result.message}`, 'error');
                }
                
                log('', 'info');
                log('ðŸŽ‰ TESTE CONCLUÃDO!', 'success');
                log('O sistema estÃ¡ funcionando normalmente.', 'success');
                log('VocÃª pode ir para o dashboard agora.', 'info');
                
            } catch (error) {
                log(`âŒ ERRO no teste: ${error.message}`, 'error');
                console.error('Test error:', error);
            }
        }
        
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
    </script>
</body>
</html>